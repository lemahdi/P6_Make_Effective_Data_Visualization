<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    <script type='text/javascript' src="js/script.js"></script>
    <script type='text/javascript' src="js/slopegraph.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    
    <style>
      .Aligner {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .Aligner .Aligner-item {
        max-width: 50%;
      }

      /*.OnSlopegraphGroup {
        fill: red;
      }

      .OutSlopeGraphGroup {
        fill: grey;
      }*/

      .GroupHover:hover text {
        fill: red;
        overflow: visible;
      }
      .GroupHover:hover line{
        stroke: red;
        overflow: visible;
      }
    </style>

    <script type="text/javascript">
      WIDTH = 600;
      // HEIGHT = 850;
      HEIGHT = 200;

      LEFT_MARGIN = 150;
      RIGHT_MARGIN = 150;
      TOP_MARGIN = 50;
      BOTTOM_MARGIN = 50;

      FONT_SIZE = 10;

      Y1 = 1987;
      Y2 = 2008;
      
      ELIGIBLE_SIZE = HEIGHT - TOP_MARGIN - BOTTOM_MARGIN;


      function slopegraph(all_data) {
        // loading data
        var data = _to_data("1987","2008", all_data);

        // scaling
        var _y = d3.scale.linear()
              .domain([_min_key(data), _max_key(data)])
              .range([TOP_MARGIN, HEIGHT-BOTTOM_MARGIN])

        function y(d,i){
          return HEIGHT - _y(d)
        }

        for (var i = 0; i < data.length; i += 1){
          data[i].left_coord = y(data[i].left);
          data[i].right_coord = y(data[i].right);
        }

        data = _slopegraph_preprocess(data);
        var min, max;
        var _ = _min_max(data);
        min = _[0];
        max = _[1];

        HEIGHT = max + TOP_MARGIN + BOTTOM_MARGIN;

        // creating the svg
        var sg = d3.select('#slopegraph')
          .append('svg:svg')
          .attr('width', WIDTH)
          .attr('height', HEIGHT)
          .attr('max-width', 0.5);

        _y = d3.scale.linear()
          .domain([max, min])
          .range([TOP_MARGIN, HEIGHT-BOTTOM_MARGIN])

        function x(o,i) {
          return LEFT_MARGIN-45+o;
        };

        function y(d,i){
         return HEIGHT - _y(d);
        };

        var group = sg.selectAll().data(data).enter()
          .append('svg:g')
            // .on('mouseover', function(d) {
            //   d3.select(this)
            //     .attr('class', 'OnSlopegraphGroup');
            // })
            // .on('mouseout', function(d) {
            //   d3.select(this)
            //     .attr('class', 'OutSlopeGraphGroup');
            // })
            // .attr('fill', 'grey');;
            .attr('class', 'GroupHover');
        // left labels
        group.append('svg:text')
          .attr('x', function(d,i) {
            return x(d.dx);
          })
          .attr('y', function(d,i){
            return y(d.left_coord);
          })
          .attr('dy', '.35em')
          .attr('font-size', FONT_SIZE)
          .attr('font-weight', 'bold')
          .attr('text-anchor', 'end')
          .text(function(d,i){ return d.label; })
          .attr('fill', 'grey');
        // left values
        group.append('svg:text')
          .attr('x', LEFT_MARGIN-10)
          .attr('y', function(d,i){
            return y(d.left_coord);
          })
          .attr('dy', '.35em')
          .attr('font-size', FONT_SIZE)
          .attr('text-anchor', 'end')
          .text(function(d,i){ return [d.left, "%"].join("")})
          .attr('fill', 'grey');
        // right values
        group.append('svg:text')
          .attr('x', WIDTH-RIGHT_MARGIN)
          .attr('y', function(d,i){
            return y(d.right_coord);
          })
          .attr('dy', '.35em')
          .attr('dx', 10)
          .attr('font-size', FONT_SIZE)
          .text(function(d,i){ return [d.right, "%"].join("")})
          .attr('fill', 'grey');
        // slope lines
        group.append('svg:line')
          .attr('x1', LEFT_MARGIN)
          .attr('x2', WIDTH-RIGHT_MARGIN)
          .attr('y1', function(d,i){
            return y(d.left_coord)
          })
          .attr('y2', function(d,i){
            return y(d.right_coord)
          })
          .attr('opacity', .6)
          .attr('stroke', 'grey');

        // title
        sg.append('svg:text')
          .attr('x', LEFT_MARGIN)
          .attr('y', TOP_MARGIN/2)
          .attr('text-anchor', 'end')
          .attr('opacity', .5)
          .text(Y1)

        sg.append('svg:text')
          .attr('x', WIDTH-RIGHT_MARGIN)
          .attr('y', TOP_MARGIN/2)
          .attr('opacity', .5)
          .text(Y2)

        sg.append('svg:line')
          .attr('x1', LEFT_MARGIN/2)
          .attr('x2', WIDTH-RIGHT_MARGIN/2)
          .attr('y1', TOP_MARGIN*2/3)
          .attr('y2', TOP_MARGIN*2/3)
          .attr('stroke', 'black')
          .attr('opacity', .5)

        sg.append('svg:text')
          .attr('x', WIDTH/2)
          .attr('y', TOP_MARGIN/2)
          .attr('text-anchor', 'middle')
          .text('Flight Origins Ratio\n (By Airport)')
          .attr('font-variant', 'small-caps')
      }
    </script>
  </head>
<body>
  <div id='slopegraph' class="Aligner Aligner-item"></div>
  <script type="text/javascript">
    d3.csv("data/19872008SubsetAirportAttendanceRatio.csv", slopegraph);
    // d3.csv("data/sample.csv", slopegraph);
  </script>
</body>
</html>
